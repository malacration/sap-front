<section class="content">
  <div class="card card-primary">
    <div class="card-header">
      <h3 class="card-title"><b>Detalhes da Ordem de Carregamento</b></h3>
      <div class="card-tools float-right">
        <button
          (click)="gerarNotaFiscal()"
          type="button"
          class="btn btn-warning btn-sm"
          style="margin-left: 8px;"
          [disabled]="loading || selected.U_Status === 'Fechado' || selected.U_Status === 'Cancelado'"
          [title]="
            selected.U_Status === 'Fechado'
              ? 'Esta ordem já foi fechada'
              : selected.U_Status === 'Cancelado'
              ? 'Esta ordem foi cancelada'
              : ''
          "
        >
          <span *ngIf="!loading">Gerar Nota Fiscal Saída</span>
          <span *ngIf="loading"><i class="fas fa-spinner fa-spin"></i> Processando...</span>
        </button>

        <button
          (click)="abrirModalCancelamento()"
          type="button"
          class="btn btn-warning btn-sm"
          style="margin-left: 8px;"
          [disabled]="selected.U_Status === 'Cancelado' || selected.U_Status === 'Fechado'"
          [title]="
            selected.U_Status === 'Fechado'
              ? 'Esta ordem já foi fechada'
              : selected.U_Status === 'Cancelado'
              ? 'Esta ordem foi cancelada'
              : ''
          "
        >
          Cancelar
        </button>

        <button
          (click)="abrirModalItinerario()"
          type="button"
          class="btn btn-warning btn-sm"
          style="margin-left: 8px;"
        >
          Gerar Itinerário
        </button>
      </div>
    </div>
    <div class="card-body">
      <dl class="row">
        <dt class="col-sm-3">Número da Ordem:</dt>
        <dd class="col-sm-9">{{ selected.DocEntry }}</dd>

        <dt class="col-sm-3">Descrição da Ordem:</dt>
        <dd class="col-sm-9">{{ selected.U_nameOrdem }}</dd>

        <dt class="col-sm-3">Status:</dt>
        <dd class="col-sm-9">{{ selected.U_Status }}</dd>

        <dt class="col-sm-3">Data de Criação:</dt>
        <dd class="col-sm-9">{{ selected.dataCriacao }}</dd>

        <dd class="col-sm">
          <app-tabs>
            <app-tab tabTitle="Produtos" [active]="true">
              <div *ngIf="loadingPedidos" class="text-center p-4">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p>Carregando produtos...</p>
              </div>
              <app-table
                *ngIf="!loadingPedidos"
                [content]="pedidos"
                [definition]="definition"
                (actionOutput)="action($event)"
              >
              </app-table>
            </app-tab>
            <app-tab tabTitle="Logística">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Placa do Veículo</label>
                    <input
                      type="text"
                      class="form-control"
                      [(ngModel)]="placa"
                      placeholder="Ex: ABC-1234"
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Nome do Motorista</label>
                    <input
                      type="text"
                      class="form-control"
                      [(ngModel)]="nomeMotorista"
                      placeholder="Ex: João Silva"
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <!-- <app-transportadora-search (selected)="selectBp($event)"></app-transportadora-search> -->
                  </div>
                </div>
              </div>
            </app-tab>
          </app-tabs>
        </dd>
      </dl>
    </div>
    <div class="card-footer">
      <button type="button" class="btn btn-secondary" (click)="voltar()">Voltar</button>
    </div>
  </div>

  <app-modal [(show)]="showLote" [title]="'Selecione os Lotes'">
    <div class="modal-body">
      <div class="row">
        <!-- Coluna esquerda: Lista de pedidos -->
        <div class="col-md-4">
          <h5>Pedidos Disponíveis</h5>
          <div class="list-group" style="max-height: 400px; overflow-y: auto;">
            <a
              *ngFor="let pedido of pedidos"
              href="javascript:void(0)"
              class="list-group-item list-group-item-action"
              [class.active]="currentPedido?.ItemCode === pedido.ItemCode"
              (click)="selecionarPedido(pedido)"
            >
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">{{ pedido.ItemCode }} - {{ pedido.Dscription }}</h6>
                <small>Qtd: {{ pedido.Quantity }}</small>
              </div>
              <small>Depósito: {{ pedido.DflWhs }}</small>
              <div *ngIf="lotesSelecionadosPorItem.has(pedido.ItemCode)" class="text-success mt-1">
                <small>{{ lotesSelecionadosPorItem.get(pedido.ItemCode).length }} lote(s) selecionado(s)</small>
              </div>
            </a>
          </div>
        </div>

        <!-- Coluna direita: Seleção de lotes -->
        <div class="col-md-8">
          <div *ngIf="currentPedido; else noPedidoSelected">
            <h5>Lotes para {{ currentPedido.ItemCode }}</h5>
            <selecao-lote
              [itemCode]="currentPedido?.ItemCode"
              [codDeposito]="currentPedido?.DflWhs"
              [quantidade]="currentPedido?.Quantity"
              (lotesSelecionados)="lotesSelecionados($event)"
            ></selecao-lote>
          </div>
          <ng-template #noPedidoSelected>
            <div class="text-center text-muted p-4">
              <p>Selecione um pedido à esquerda para visualizar os lotes disponíveis.</p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <div class="mr-auto">
        <span *ngIf="lotesSelecionadosPorItem.size > 0">
          {{ lotesSelecionadosPorItem.size }} item(s) com lotes selecionado(s)
        </span>
      </div>
      <button
        type="button"
        class="btn btn-success"
        (click)="confirmarNotaVerde()"
        [disabled]="loading || lotesSelecionadosPorItem.size === 0"
      >
        <span *ngIf="!loading">Confirmar Nota Verde</span>
        <span *ngIf="loading"><i class="fas fa-spinner fa-spin"></i> Processando...</span>
      </button>
    </div>
  </app-modal>

  <app-modal [(show)]="showItinerarioModal" [title]="'Ordenar Itinerário de Carregamento'">
    <div class="modal-body">
      <div class="row">
        <div class="col-md-12">
          <div class="alert alert-info">
            Arraste os itens para ordenar a sequência de carregamento
          </div>
          
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th></th>
                  <th>Ordem</th>
                  <th>Núm. Pedido</th>
                  <th>Cliente</th>
                  <th>Endereço</th>
                  <th>Localidade</th>
                  <th>Item</th>
                  <th>Quantidade</th>
                </tr>
              </thead>
              <tbody #sortableList>
                <tr *ngFor="let pedido of pedidosOrdenados; let i = index" 
                    draggable="true"
                    (dragstart)="onDragStart($event, i)"
                    (dragover)="onDragOver($event, i)"
                    (dragend)="onDragEnd($event)"
                    (drop)="onDrop($event, i)"
                    class="draggable-item">
                  <td><i class="fas fa-grip-vertical text-muted"></i></td>
                  <td>{{i + 1}}</td>
                  <td>{{pedido.DocNum}}</td>
                  <td>{{pedido.CardName}}</td>
                  <td>{{pedido.Address2}}</td>
                  <td>{{localidadesMap.get(pedido.CardCode) || 'Não informado'}}</td>
                  <td>{{pedido.ItemCode}} - {{pedido.Dscription}}</td>
                  <td>{{pedido.Quantity}}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="resetarOrdem()">Resetar Ordem</button>
      <div class="pdf-preview-container" style="height: 80vh; padding: 10px;">
        <div class="pdf-toolbar">
          <button (click)="gerarPDF()" class="btn btn-success btn-sm">Gerar PDF</button>
        </div>
        <div class="pdf-preview" style="overflow-y: auto; height: calc(100% - 50px);">
          <div class="pdf-preview-content">
            <app-itinerario-pdf 
              [pedidosOrdenados]="pedidosOrdenados" 
              [ordemCarregamento]="selected" 
              [businessPartner]="businesPartner" 
              [localidadesMap]="localidadesMap">
            </app-itinerario-pdf>
          </div>
        </div>
      </div>
    </div>
  </app-modal>

  <!-- Cancelamento -->
<app-modal [(show)]="showCancelamentoModal" [title]="'Selecionar Pedidos para Cancelar'" [modalSize]="'lg'">
  <div class="modal-body">
    <div class="alert alert-info">
      <i class="fas fa-info-circle"></i> Selecione os pedidos que deseja cancelar nesta ordem de carregamento.
    </div>
    
    <!-- Filtro de pesquisa -->
    <div class="row mb-3">
      <div class="col-md-6">
        <div class="input-group">
          <span class="input-group-text">
            <i class="fas fa-search"></i>
          </span>
          <input 
            type="text" 
            class="form-control" 
            placeholder="Pesquisar por número do pedido..." 
            [(ngModel)]="filtroPesquisa"
            (input)="filtrarPedidos()"
          >
          <button 
            class="btn btn-outline-secondary" 
            type="button" 
            (click)="limparFiltro()"
            [disabled]="!filtroPesquisa"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="selectAll" 
                 [(ngModel)]="selectAllPedidos" 
                 (change)="toggleSelectAll()"
                 [disabled]="pedidosFiltrados.length === 0">
          <label class="form-check-label" for="selectAll">
            Selecionar Todos os Pedidos Visíveis
          </label>
        </div>
      </div>
    </div>

<div class="table-responsive">
  <table class="table table-hover">
    <thead>
      <tr>
        <th width="50px"></th>
        <th>Núm. Pedido</th>
        <th>Cliente</th>
        <th>Item</th>
        <th>Quantidade</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      <tr 
        *ngFor="let pedido of pedidosFiltrados" 
        [class.table-active]="pedido.selected"
        [class.disabled-row]="pedido.U_Status === 'Cancelado'"
        (click)="toggleSelecaoPedido(pedido, $event)"
        [style.cursor]="pedido.U_Status === 'Cancelado' ? 'not-allowed' : 'pointer'"
      >
        <td (click)="$event.stopPropagation()">
          <input 
            type="checkbox" 
            [(ngModel)]="pedido.selected" 
            (change)="verificarSelecaoTotal()"
            [disabled]="pedido.U_Status === 'Cancelado'"
            (click)="$event.stopPropagation()"
          >
        </td>
        <td>
          <span class="badge bg-primary">{{ pedido.DocNum }}</span>
        </td>
        <td>{{ pedido.CardName }}</td>
        <td>{{ pedido.ItemCode }} - {{ pedido.Dscription }}</td>
        <td>{{ pedido.Quantity }}</td>
        <td>
          <span class="badge" [ngClass]="{
            'badge-success': pedido.U_Status === 'Aberto',
            'badge-danger': pedido.U_Status === 'Cancelado',
            'badge-warning': pedido.U_Status === 'Faturado'
          }">
            {{ pedido.U_Status }}
          </span>
        </td>
      </tr>
    </tbody>
  </table>
</div>

    <div *ngIf="pedidosFiltrados.length === 0" class="text-center text-muted p-4">
      <i class="fas fa-search fa-2x mb-2"></i>
      <p>Nenhum pedido encontrado para "{{ filtroPesquisa }}"</p>
    </div>

    <div *ngIf="pedidosSelecionados.length > 0" class="alert alert-warning mt-3">
      <strong>{{ pedidosSelecionados.length }} pedido(s) selecionado(s) para cancelamento</strong>
      <div *ngIf="filtroPesquisa" class="mt-1">
        <small>Nota: A seleção inclui apenas pedidos visíveis no filtro atual</small>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <div class="me-auto">
      <span class="text-muted">
        {{ pedidosFiltrados.length }} de {{ pedidosParaCancelamento.length }} pedidos visíveis
      </span>
    </div>
    <button type="button" class="btn btn-secondary" (click)="fecharModalCancelamento()">Fechar</button>
    <button 
      type="button" 
      class="btn btn-danger" 
      (click)="confirmarCancelamentoSelecionados()"
      [disabled]="pedidosSelecionados.length === 0 || loadingCancelamento"
    >
      <span *ngIf="!loadingCancelamento">Cancelar Pedidos Selecionados</span>
      <span *ngIf="loadingCancelamento"><i class="fas fa-spinner fa-spin"></i> Processando...</span>
    </button>
  </div>
</app-modal>
</section>